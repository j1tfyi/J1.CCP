#!/usr/bin/env node

/**
 * Simplified session token generator for local development
 * This creates mock session tokens for testing Coinbase Onramp/Offramp
 */

import express from 'express';
import cors from 'cors';
import crypto from 'crypto';

const app = express();
const PORT = 3001;

// J1.CCP wallet address
const J1_CCP_ADDRESS = "0x4A671c9424a95eA56da39D6fd13928e6aFB0Eb3E";

// Middleware
app.use(cors());
app.use(express.json());

// Session token endpoint
app.post('/api/session', (req, res) => {
  console.log('[Session API] Generating session token...');
  
  const { addresses, assets } = req.body;
  
  // Use provided addresses or default to J1.CCP
  const targetAddresses = addresses || [{
    address: J1_CCP_ADDRESS,
    blockchains: ["ethereum", "base", "polygon", "arbitrum", "optimism"]
  }];

  // Generate a mock session token that looks realistic
  // In production, this would be generated by Coinbase CDP API
  const sessionData = {
    addresses: targetAddresses,
    assets: assets || ["ETH", "USDC", "USDT", "DAI"],
    timestamp: Date.now(),
    nonce: crypto.randomBytes(16).toString('hex'),
    projectId: "80a2acea-83de-40aa-be1e-081d47e196c8",
    env: "development"
  };

  // Create a base64-encoded token
  const token = Buffer.from(JSON.stringify(sessionData)).toString('base64');
  
  console.log('[Session API] Token generated successfully');
  
  res.json({
    token: token,
    channel_id: `dev-${Date.now()}`,
    expires_at: new Date(Date.now() + 600000).toISOString(),
    note: 'Development token - In production this would be from CDP API'
  });
});

// Health check
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok', service: 'session-api' });
});

// Widget config endpoint
app.get('/widget-config', (req, res) => {
  res.json({
    element: 'debridgeWidget',
    inputChain: 1,
    outputChain: 7565164,
    inputCurrency: '0x0000000000000000000000000000000000000000',
    outputCurrency: '11111111111111111111111111111111',
    mode: 'deswap',
    affiliateFeePercent: 0.5,
    affiliateFeeRecipient: J1_CCP_ADDRESS,
    r: '32422',
    isHideLogo: true,
    theme: 'dark'
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`
╔════════════════════════════════════════════════════╗
║   Session Token API Server (Dev Mode)              ║
╠════════════════════════════════════════════════════╣
║   Port: ${PORT}                                    ║
║   Session: http://localhost:${PORT}/api/session    ║
║   Health: http://localhost:${PORT}/api/health      ║
╚════════════════════════════════════════════════════╝

✨ Ready to handle Coinbase Onramp/Offramp requests!
  `);
});